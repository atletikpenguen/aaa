<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Grid + OTT Trading Bot{% endblock %}</title>
    
    <!-- Tailwind CSS CDN - Development only -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS production uyarÄ±sÄ±nÄ± tamamen gizle
        const originalWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('cdn.tailwindcss.com should not be used in production')) {
                return; // Bu uyarÄ±yÄ± tamamen gizle
            }
            originalWarn.apply(console, args);
        };
    </script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.14.1/dist/cdn.min.js"></script>
    <script>
        // Alpine.js hata yakalama
        document.addEventListener('alpine:init', () => {
            console.log('Alpine.js initialized');
        });
        
        // Alpine.js expression hatalarÄ±nÄ± yakala
        document.addEventListener('alpine:error', (e) => {
            console.warn('Alpine Expression Error:', e.detail.error);
            console.warn('Expression:', e.detail.expression);
        });
        
        // Global hata yakalama
        window.addEventListener('error', (e) => {
            console.error('JavaScript Error:', e.error);
        });
        
        // Unhandled promise rejection yakalama
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled Promise Rejection:', e.reason);
        });
    </script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='app.css') }}">
    
    <style>
        [x-cloak] { display: none !important; }
        
        .status-badge {
            @apply px-2 py-1 text-xs font-semibold rounded-full;
        }
        
        .status-active {
            @apply bg-green-100 text-green-800;
        }
        
        .status-inactive {
            @apply bg-gray-100 text-gray-800;
        }
        
        .status-running {
            @apply bg-blue-100 text-blue-800;
        }
        
        .card {
            @apply bg-white rounded-lg shadow-md border border-gray-200 p-6;
        }
        
        .btn {
            @apply px-4 py-2 rounded-md font-medium focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
        }
        
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700 focus:ring-green-500;
        }
        
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
        
        .new-trade-highlight {
            @apply bg-green-50 border-l-4 border-green-400;
            animation: fadeToNormal 2s ease-in-out;
        }
        
        @keyframes fadeToNormal {
            0% { @apply bg-green-100; }
            100% { @apply bg-white; }
        }
        
        .btn-secondary {
            @apply bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500;
        }
        
        .btn-warning {
            @apply bg-yellow-600 text-white hover:bg-yellow-700 focus:ring-yellow-500;
        }
        
        .loading {
            @apply opacity-50 cursor-not-allowed;
        }
        
        .pulse-dot {
            animation: pulse-dot 2s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">GT</span>
                        </div>
                        <span class="text-xl font-bold text-gray-900">Grid + OTT Bot</span>
                    </a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
                        <span>Aktif</span>
                    </div>
                    
                    <a href="/health" 
                       class="text-gray-600 hover:text-gray-900 text-sm font-medium"
                       hx-get="/health" 
                       hx-target="#health-modal-content" 
                       hx-trigger="click"
                       @click="$dispatch('open-modal', {modal: 'health'})">
                        Sistem Durumu
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        {% block content %}{% endblock %}
    </main>

    <!-- Modals Container -->
    <div id="modals-container">
        <!-- Health Modal -->
        <div x-data="{ open: false }" 
             x-show="open" 
             @open-modal.window="open = ($event.detail.modal === 'health')"
             @close-modal.window="open = false"
             @keydown.escape.window="open = false"
             x-cloak
             class="fixed inset-0 z-50 overflow-y-auto"
             style="display: none;">
            
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" 
                     @click="open = false"></div>
                
                <div class="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-lg">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
                        Sistem Durumu
                    </h3>
                    
                    <div id="health-modal-content" class="text-sm text-gray-600">
                        YÃ¼kleniyor...
                    </div>
                    
                    <div class="mt-6">
                        <button type="button" 
                                @click="open = false"
                                class="btn btn-secondary w-full">
                            Kapat
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create Strategy Modal -->
        <div x-data="{ open: false }" 
             x-show="open" 
             @open-modal.window="open = ($event.detail.modal === 'create-strategy')"
             @close-modal.window="open = false"
             @keydown.escape.window="open = false"
             x-cloak
             class="fixed inset-0 z-50 overflow-y-auto"
             style="display: none;">
            
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" 
                     @click="open = false"></div>
                
                <div class="inline-block w-full max-w-2xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-lg">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-6">
                        Yeni Strateji OluÅŸtur
                    </h3>
                    
                    <form hx-post="/strategies" 
                          hx-target="body"
                          hx-on::after-request="if(event.detail.successful) $dispatch('close-modal')"
                          x-data="{ strategyType: 'grid_ott' }"
                          @submit="handleStrategySubmit()"
                          class="space-y-4">
                        
                        <!-- Strateji TÃ¼rÃ¼ SeÃ§imi (tam geniÅŸlik) -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Strateji TÃ¼rÃ¼
                            </label>
                            <select name="strategy_type" 
                                    x-model="strategyType"
                                    required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="grid_ott">Grid + OTT Stratejisi</option>
                                <option value="dca_ott">DCA + OTT Stratejisi</option>
                                <option value="bol_grid">BOL-Grid Stratejisi (YENÄ°!)</option>
                            </select>
                            <div class="mt-2 text-sm text-gray-600">
                                <div x-show="strategyType === 'grid_ott'" class="space-y-1">
                                    <p>ðŸŽ¯ <strong>Grid + OTT:</strong> Trend yÃ¶nÃ¼ne gÃ¶re grid seviyelerde alÄ±ÅŸ-satÄ±ÅŸ</p>
                                    <p class="text-xs">â€¢ Ã‡ift yÃ¶nlÃ¼ kar â€¢ Grid aralÄ±klarÄ± â€¢ Matematiksel seviyeleme</p>
                                </div>
                                <div x-show="strategyType === 'dca_ott'" class="space-y-1">
                                    <p>ðŸ”¥ <strong>DCA + OTT:</strong> AkÄ±llÄ± ortalama alÄ±m stratejisi</p>
                                    <p class="text-xs">â€¢ Long-only â€¢ AkÄ±llÄ± DCA â€¢ Kademeli giriÅŸ â€¢ KÃ¢rlÄ±lÄ±k Ã§Ä±kÄ±ÅŸÄ±</p>
                                </div>
                                <div x-show="strategyType === 'bol_grid'" class="space-y-1">
                                    <p>ðŸ“Š <strong>BOL-Grid:</strong> Bollinger Bands tabanlÄ± dÃ¶ngÃ¼sel strateji</p>
                                    <p class="text-xs">â€¢ Bollinger cross sinyalleri â€¢ DÃ¶ngÃ¼sel alÄ±m-satÄ±m â€¢ Risk yÃ¶netimi</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Strateji AdÄ±
                                </label>
                                <input type="text" 
                                       name="name" 
                                       required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Ã–rn: BTC Grid 1">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Sembol
                                </label>
                                <select name="symbol" 
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="BTCUSDT">BTCUSDT</option>
                                    <option value="ETHUSDT">ETHUSDT</option>
                                    <option value="AVAXUSDT">AVAXUSDT</option>
                                    <option value="SOLUSDT">SOLUSDT</option>
                                    <option value="DOGEUSDT">DOGEUSDT</option>
				    <option value="HUMAUSDT">HUMAUSDT</option>
     				    <option value="ZROUSDT">ZROUSDT</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Zaman Dilimi
                                </label>
                                <select name="timeframe" 
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="1m">1 Dakika</option>
                                    <option value="5m" selected>5 Dakika</option>
                                    <option value="15m">15 Dakika</option>
                                    <option value="1h">1 Saat</option>
                                    <option value="1d">1 GÃ¼n</option>
                                </select>
                            </div>
                            
                            <!-- Grid+OTT Ã–zel Alanlar -->
                            <div x-bind:class="strategyType === 'grid_ott' ? '' : 'hidden'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Grid AralÄ±ÄŸÄ± (y)
                                </label>
                                <input type="number" 
                                       name="y" 
                                       step="0.000001"
                                       required
                                       value="200"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="200">
                                <p class="text-xs text-gray-500 mt-1">Grid seviyeleri arasÄ± fiyat mesafesi</p>
                            </div>
                            
                            <div x-bind:class="strategyType === 'grid_ott' ? '' : 'hidden'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    USDT/Grid
                                </label>
                                <input type="number" 
                                       name="usdt_grid" 
                                       step="0.01"
                                       required
                                       value="100"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="100">
                                <p class="text-xs text-gray-500 mt-1">Her grid seviyesi iÃ§in kullanÄ±lacak USDT</p>
                            </div>
                            
                            <div x-bind:class="strategyType === 'grid_ott' ? '' : 'hidden'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    GiriÅŸ FiyatÄ± (GF)
                                </label>
                                <input type="number" 
                                       name="gf" 
                                       step="0.000001"
                                       value="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="0 (otomatik)">
                                <p class="text-xs text-gray-500 mt-1">Grid foundation baÅŸlangÄ±Ã§ fiyatÄ±</p>
                            </div>
                            
                            <!-- DCA+OTT Ã–zel Alanlar -->
                            <div x-show="strategyType === 'dca_ott'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Ä°lk AlÄ±m TutarÄ± (USDT)
                                </label>
                                <input type="number" 
                                       name="base_usdt" 
                                       step="0.01"
                                       :required="strategyType === 'dca_ott'"
                                       value="100"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="100">
                                <p class="text-xs text-gray-500 mt-1">Ä°lk giriÅŸ iÃ§in kullanÄ±lacak USDT miktarÄ±</p>
                            </div>
                            
                            <div x-show="strategyType === 'dca_ott'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    DCA Ã‡arpanÄ±
                                </label>
                                <input type="number" 
                                       name="dca_multiplier" 
                                       step="0.1"
                                       :required="strategyType === 'dca_ott'"
                                       value="1.5"
                                       min="1.0"
                                       max="5.0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="1.5">
                                <p class="text-xs text-gray-500 mt-1">Her DCA'da alÄ±m miktarÄ± Ã§arpanÄ± (1.5 = %50 artÄ±ÅŸ)</p>
                            </div>
                            
                            <div x-show="strategyType === 'dca_ott'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Min DÃ¼ÅŸÃ¼ÅŸ YÃ¼zdesi (%)
                                </label>
                                <input type="number" 
                                       name="min_drop_pct" 
                                       step="0.1"
                                       :required="strategyType === 'dca_ott'"
                                       value="2.0"
                                       min="0.5"
                                       max="20.0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="2.0">
                                <p class="text-xs text-gray-500 mt-1">DCA tetiklenmesi iÃ§in minimum dÃ¼ÅŸÃ¼ÅŸ yÃ¼zdesi</p>
                            </div>
                            
                            <div x-show="strategyType === 'dca_ott'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Kar AlÄ±m EÅŸiÄŸi (%)
                                </label>
                                <input type="number" 
                                       name="profit_threshold_pct" 
                                       step="0.1"
                                       :required="strategyType === 'dca_ott'"
                                       value="1.0"
                                       min="0.1"
                                       max="10.0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="1.0">
                                <p class="text-xs text-gray-500 mt-1">Kar alÄ±m iÃ§in minimum kar yÃ¼zdesi</p>
                            </div>
                            
                            <!-- BOL-Grid Ã–zel Alanlar -->
                            <div x-show="strategyType === 'bol_grid'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Ä°lk AlÄ±m TutarÄ± (USDT)
                                </label>
                                <input type="number" 
                                       name="initial_usdt" 
                                       step="1"
                                       :required="strategyType === 'bol_grid'"
                                       value="100"
                                       min="10"
                                       max="10000"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="100">
                                <p class="text-xs text-gray-500 mt-1">Her alÄ±m iÃ§in kullanÄ±lacak USDT miktarÄ±</p>
                            </div>
                            
                            <div x-show="strategyType === 'bol_grid'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Min DÃ¼ÅŸÃ¼ÅŸ YÃ¼zdesi (%)
                                </label>
                                <input type="number" 
                                       name="min_drop_pct" 
                                       step="0.1"
                                       :required="strategyType === 'bol_grid'"
                                       value="2.0"
                                       min="0.5"
                                       max="20.0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="2.0">
                                <p class="text-xs text-gray-500 mt-1">Ek alÄ±m iÃ§in minimum dÃ¼ÅŸÃ¼ÅŸ yÃ¼zdesi</p>
                            </div>
                            
                            <div x-show="strategyType === 'bol_grid'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Min Kar YÃ¼zdesi (%)
                                </label>
                                <input type="number" 
                                       name="min_profit_pct" 
                                       step="0.1"
                                       :required="strategyType === 'bol_grid'"
                                       value="1.0"
                                       min="0.1"
                                       max="10.0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="1.0">
                                <p class="text-xs text-gray-500 mt-1">SatÄ±ÅŸ iÃ§in minimum kar yÃ¼zdesi</p>
                            </div>
                            
                            <div x-show="strategyType === 'bol_grid'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Bollinger Periyodu
                                </label>
                                <input type="number" 
                                       name="bollinger_period" 
                                       step="1"
                                       :required="strategyType === 'bol_grid'"
                                       value="250"
                                       min="20"
                                       max="500"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="250">
                                <p class="text-xs text-gray-500 mt-1">Bollinger Bands hesaplama periyodu</p>
                            </div>
                            
                            <div x-show="strategyType === 'bol_grid'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Standart Sapma
                                </label>
                                <input type="number" 
                                       name="bollinger_std" 
                                       step="0.1"
                                       :required="strategyType === 'bol_grid'"
                                       value="2.0"
                                       min="1.0"
                                       max="3.0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="2.0">
                                <p class="text-xs text-gray-500 mt-1">Bollinger Bands geniÅŸliÄŸi (standart sapma)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Min Fiyat Limiti
                                </label>
                                <input type="number" 
                                       name="price_min" 
                                       step="0.000001"
                                       min="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Opsiyonel - alt fiyat sÄ±nÄ±rÄ±">
                                <p class="text-xs text-gray-500 mt-1">Bu fiyatÄ±n altÄ±nda iÅŸlem yapÄ±lmaz</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Max Fiyat Limiti
                                </label>
                                <input type="number" 
                                       name="price_max" 
                                       step="0.000001"
                                       min="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Opsiyonel - Ã¼st fiyat sÄ±nÄ±rÄ±">
                                <p class="text-xs text-gray-500 mt-1">Bu fiyatÄ±n Ã¼stÃ¼nde iÅŸlem yapÄ±lmaz</p>
                            </div>
                            
                            <!-- OTT alanlarÄ± - BOL-Grid iÃ§in gizli -->
                            <div x-show="strategyType !== 'bol_grid'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    OTT Period
                                </label>
                                <input type="number" 
                                       name="ott_period" 
                                       min="1" 
                                       max="200"
                                       value="14"
                                       :required="strategyType !== 'bol_grid'"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div x-show="strategyType !== 'bol_grid'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    OTT Opt (%)
                                </label>
                                <input type="number" 
                                       name="ott_opt" 
                                       step="0.1"
                                       min="0.1"
                                       max="10"
                                       value="2.0"
                                       :required="strategyType !== 'bol_grid'"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" 
                                    @click="$dispatch('close-modal')"
                                    class="btn btn-secondary">
                                Ä°ptal
                            </button>
                            <button type="submit" 
                                    class="btn btn-primary">
                                OluÅŸtur
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Strategy Modal -->
    <div x-data="{ 
            open: false, 
            strategyData: null,
            init() {
                this.$watch('open', value => {
                    if (value && this.strategyData) {
                        this.populateForm();
                    }
                });
            },
            populateForm() {
                console.log('populateForm called with:', this.strategyData);
                if (!this.strategyData) {
                    console.log('strategyData is null, skipping form population');
                    return;
                }
                const form = this.$refs.editForm;
                if (form) {
                    form.name.value = this.strategyData.name || '';
                    form.y.value = this.strategyData.y || '';
                    form.usdt_grid.value = this.strategyData.usdt_grid || '';
                    form.gf.value = this.strategyData.gf || 0;
                    form.price_min.value = this.strategyData.price_min === null ? '' : this.strategyData.price_min || '';
                    form.price_max.value = this.strategyData.price_max === null ? '' : this.strategyData.price_max || '';
                    form.ott_period.value = this.strategyData.ott_period || 14;
                    form.ott_opt.value = this.strategyData.ott_opt || 2.0;
                    console.log('Form populated successfully');
                } else {
                    console.log('Form element not found');
                }
            }
         }" 
         x-show="open" 
         @open-edit-modal.window="strategyData = $event.detail; if (strategyData) open = true"
         @close-modal.window="open = false"
         @keydown.escape.window="open = false"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         style="display: none;">
        
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" 
                 @click="open = false"></div>
            
            <div class="inline-block w-full max-w-2xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-lg">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-6">
                    Strateji DÃ¼zenle
                </h3>
                
                <form x-ref="editForm"
                      method="POST"
                      action="/strategies/update"
                      hx-post="/strategies/update"
                      hx-target="body"
                      hx-on::after-request="if(event.detail.successful) $dispatch('close-modal')"
                      @submit="console.log('Strategy Data:', strategyData)"
                      class="space-y-4">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Hidden fields for method override and strategy ID -->
                        <input type="hidden" name="method_override" value="PUT">
                        <input type="hidden" name="strategy_id" :value="strategyData ? strategyData.strategyId : ''">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Strateji AdÄ±
                            </label>
                            <input type="text" 
                                   name="name" 
                                   required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Ã–rn: BTC Grid 1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Grid AralÄ±ÄŸÄ± (y)
                            </label>
                            <input type="number" 
                                   name="y" 
                                   step="0.000001"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="200">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                USDT/Grid
                            </label>
                            <input type="number" 
                                   name="usdt_grid" 
                                   step="0.01"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="100">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                GiriÅŸ FiyatÄ± (GF)
                            </label>
                            <input type="number" 
                                   name="gf" 
                                   step="0.000001"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="0 (otomatik)">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Min Fiyat Limiti
                            </label>
                            <input type="number" 
                                   name="price_min" 
                                   step="0.000001"
                                   min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Opsiyonel - alt fiyat sÄ±nÄ±rÄ±">
                            <p class="text-xs text-gray-500 mt-1">Bu fiyatÄ±n altÄ±nda iÅŸlem yapÄ±lmaz</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Max Fiyat Limiti
                            </label>
                            <input type="number" 
                                   name="price_max" 
                                   step="0.000001"
                                   min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Opsiyonel - Ã¼st fiyat sÄ±nÄ±rÄ±">
                            <p class="text-xs text-gray-500 mt-1">Bu fiyatÄ±n Ã¼stÃ¼nde iÅŸlem yapÄ±lmaz</p>
                        </div>
                        
                        <!-- OTT alanlarÄ± - BOL-Grid iÃ§in gizli -->
                        <div x-show="strategyData && strategyData.strategy_type !== 'bol_grid'">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                OTT Period
                            </label>
                            <input type="number" 
                                   name="ott_period" 
                                   min="1" 
                                   max="200"
                                   :required="strategyData && strategyData.strategy_type !== 'bol_grid'"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div x-show="strategyData && strategyData.strategy_type !== 'bol_grid'">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                OTT Opt (%)
                            </label>
                            <input type="number" 
                                   name="ott_opt" 
                                   step="0.1"
                                   min="0.1"
                                   max="10"
                                   :required="strategyData && strategyData.strategy_type !== 'bol_grid'"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mt-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-yellow-800">Dikkat</h3>
                                <div class="mt-1 text-sm text-yellow-700">
                                    Aktif strateji parametrelerini deÄŸiÅŸtirmek mevcut iÅŸlemleri etkileyebilir. DeÄŸiÅŸiklik yapmadan Ã¶nce stratejiyi durdurmanÄ±z Ã¶nerilir.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" 
                                @click="$dispatch('close-modal')"
                                class="btn btn-secondary">
                            Ä°ptal
                        </button>
                        <button type="submit" 
                                class="btn btn-primary">
                            GÃ¼ncelle
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notifications (Vanilla JS) -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- HTMX Extensions -->
    <script>
        // Simple Toast System (Vanilla JS) - Duplicate declaration guard
        if (typeof SimpleToast === 'undefined') {
            class SimpleToast {
            constructor() {
                this.container = document.getElementById('toast-container');
                this.init();
            }
            
            init() {
                // Listen for toast events
                window.addEventListener('show-toast', (event) => {
                    this.showToast(event.detail);
                });
            }
            
            showToast(toastData) {
                if (!toastData || !this.container) return;
                
                const toast = document.createElement('div');
                toast.className = 'bg-white border-l-4 border-blue-500 rounded-md shadow-lg p-4 max-w-sm transform transition-all duration-300 opacity-0 translate-x-2';
                toast.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">${toastData.title || 'Bildirim'}</p>
                            <p class="text-sm text-gray-600">${toastData.message || ''}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">
                            <span class="sr-only">Kapat</span>
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                this.container.appendChild(toast);
                
                // Animate in
                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-x-2');
                    toast.classList.add('opacity-100', 'translate-x-0');
                }, 100);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.classList.add('opacity-0', 'translate-x-2');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 5000);
            }
        }
        
        // Initialize toast system
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.toastSystem) {
                window.toastSystem = new SimpleToast();
            }
        });
        } // End of SimpleToast guard
        
        // HTMX event listeners - Duplicate declaration guard - DÃœZELTME (25 EylÃ¼l 2025)
        if (!window.htmxEventListenersInitialized) {
            document.addEventListener('htmx:afterRequest', function(event) {
            try {
                if (event.detail && event.detail.successful) {
                    // Success toast
                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: {
                            id: Date.now() + Math.random(),
                            title: 'BaÅŸarÄ±lÄ±',
                            message: 'Ä°ÅŸlem tamamlandÄ±'
                        }
                    }));
                } else {
                    // Error toast
                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: {
                            id: Date.now() + Math.random(),
                            title: 'Hata',
                            message: 'Ä°ÅŸlem baÅŸarÄ±sÄ±z oldu'
                        }
                    }));
                }
            } catch (error) {
                console.error('HTMX event handler error:', error);
            }
        });
        
        // HTMX abort hatalarÄ±nÄ± yakala ve logla
        document.addEventListener('htmx:sendAbort', function(event) {
            console.log('HTMX request aborted:', event.detail);
        });
        
        // HTMX hata yÃ¶netimi
        document.addEventListener('htmx:responseError', function(event) {
            console.warn('HTMX response error:', event.detail);
        });
        
        // HTMX network hatalarÄ±nÄ± yakala
        document.addEventListener('htmx:sendError', function(event) {
            console.warn('HTMX send error:', event.detail);
        });
        
        // Promise rejection hatalarÄ±nÄ± yakala
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && event.reason.message.includes('htmx')) {
                console.warn('HTMX promise rejection caught:', event.reason);
                event.preventDefault(); // Hata konsola yazdÄ±rÄ±lmasÄ±nÄ± engelle
            }
        });
            
            // Mark as initialized
            window.htmxEventListenersInitialized = true;
        } // End of HTMX event listeners guard
        
        // Strategy form submit handler
        function handleStrategySubmit() {
            try {
                const strategyTypeElement = document.querySelector('[name="strategy_type"]');
                if (!strategyTypeElement) {
                    console.error('Strategy type element not found');
                    return;
                }
                
                const strategyType = strategyTypeElement.value;
                
                // Strateji tipine gÃ¶re field'larÄ± ayarla
                if (strategyType === 'dca_ott') {
                    // DCA+OTT field'larÄ±nÄ± gÃ¶nder, Grid field'larÄ±nÄ± gizle
                    document.querySelectorAll('[name="y"], [name="usdt_grid"], [name="gf"]').forEach(f => f.disabled = true);
                    document.querySelectorAll('[name="base_usdt"], [name="dca_multiplier"], [name="min_drop_pct"], [name="profit_threshold_pct"]').forEach(f => f.disabled = false);
                } else {
                    // Grid+OTT field'larÄ±nÄ± gÃ¶nder, DCA field'larÄ±nÄ± gizle
                    document.querySelectorAll('[name="y"], [name="usdt_grid"], [name="gf"]').forEach(f => f.disabled = false);
                    document.querySelectorAll('[name="base_usdt"], [name="dca_multiplier"], [name="min_drop_pct"]').forEach(f => f.disabled = true);
                }
                
                // BoÅŸ alanlarÄ± temizle
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    if (input.value === '' || input.value === '0') {
                        input.value = '';
                    }
                });
            } catch (error) {
                console.error('Strategy form submit handler error:', error);
            }
        }
        
        // Position Tracker Component
        function positionTracker() {
            return {
                loading: false,
                positions: [],
                netPosition: 0,
                totalLong: 0,
                totalShort: 0,
                maxLimit: 2000,
                minLimit: -1200,
                riskStatus: 'safe',
                riskMessage: '',
                lastUpdate: null,
                
                init() {
                    this.refreshPositions();
                    // Her 60 saniyede bir otomatik yenile - DÃœZELTME (25 EylÃ¼l 2025)
                    // Duplicate interval'larÄ± Ã¶nle
                    if (window.positionInterval) {
                        clearInterval(window.positionInterval);
                    }
                    window.positionInterval = setInterval(() => {
                        if (!window.positionRefreshing) {
                            window.positionRefreshing = true;
                            this.refreshPositions().finally(() => {
                                window.positionRefreshing = false;
                            });
                        }
                    }, 60000);
                },
                
                async refreshPositions() {
                    if (this.loading) return;
                    
                    this.loading = true;
                    try {
                        const response = await fetch('/api/positions');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result && result.status === 'success') {
                            const data = result.data || {};
                            this.positions = data.positions || [];
                            this.netPosition = data.net_position_usd || 0;
                            this.totalLong = data.total_long_usd || 0;
                            this.totalShort = data.total_short_usd || 0;
                            this.lastUpdate = new Date();
                            
                            // Limitleri gÃ¼ncelle
                            if (data.limits) {
                                this.maxLimit = data.limits.max_position_usd || 2000;
                                this.minLimit = data.limits.min_position_usd || -1200;
                            }
                            
                            // Risk durumunu hesapla
                            this.calculateRiskStatus();
                        } else {
                            console.error('Pozisyon bilgisi alma hatasÄ±:', result?.message || 'Bilinmeyen hata');
                        }
                    } catch (error) {
                        console.error('Pozisyon yenileme hatasÄ±:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                calculateRiskStatus() {
                    const maxThreshold = this.maxLimit * 0.8; // %80
                    const minThreshold = this.minLimit * 0.8; // %80
                    
                    if (this.netPosition >= maxThreshold) {
                        this.riskStatus = 'danger';
                        this.riskMessage = `Maksimum limite yakÄ±n (${((this.netPosition / this.maxLimit) * 100).toFixed(1)}%)`;
                    } else if (this.netPosition <= minThreshold) {
                        this.riskStatus = 'danger';
                        this.riskMessage = `Minimum limite yakÄ±n (${((this.netPosition / this.minLimit) * 100).toFixed(1)}%)`;
                    } else if (this.netPosition >= this.maxLimit * 0.6 || this.netPosition <= this.minLimit * 0.6) {
                        this.riskStatus = 'warning';
                        this.riskMessage = 'Pozisyon limitine yaklaÅŸÄ±yor';
                    } else {
                        this.riskStatus = 'safe';
                        this.riskMessage = 'Pozisyon gÃ¼venli aralÄ±kta';
                    }
                },
                
                async updateLimits() {
                    try {
                        const formData = new FormData();
                        formData.append('max_position_usd', this.maxLimit || 2000);
                        formData.append('min_position_usd', this.minLimit || -1200);
                        
                        const response = await fetch('/api/positions/limits', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        if (result && result.status === 'success') {
                            this.calculateRiskStatus();
                            window.dispatchEvent(new CustomEvent('show-toast', {
                                detail: {
                                    id: Date.now() + Math.random(),
                                    title: 'BaÅŸarÄ±lÄ±',
                                    message: 'Pozisyon limitleri gÃ¼ncellendi'
                                }
                            }));
                        } else {
                            throw new Error(result?.message || 'Bilinmeyen hata');
                        }
                    } catch (error) {
                        console.error('Limit gÃ¼ncelleme hatasÄ±:', error);
                        window.dispatchEvent(new CustomEvent('show-toast', {
                            detail: {
                                id: Date.now() + Math.random(),
                                title: 'Hata',
                                message: 'Limit gÃ¼ncelleme baÅŸarÄ±sÄ±z: ' + (error.message || 'Bilinmeyen hata')
                            }
                        }));
                    }
                }
            };
        }
        
        // Volume Tracker Component
        function volumeTracker() {
            return {
                loading: false,
                volumeData: [],
                totalLongVolume: 0,
                totalShortVolume: 0,
                totalNetVolume: 0,
                totalTrades: 0,
                
                init() {
                    this.refreshVolume();
                    // Her 5 dakikada bir otomatik yenile - DÃœZELTME (25 EylÃ¼l 2025)
                    // Duplicate interval'larÄ± Ã¶nle
                    if (window.volumeInterval) {
                        clearInterval(window.volumeInterval);
                    }
                    window.volumeInterval = setInterval(() => {
                        if (!window.volumeRefreshing) {
                            window.volumeRefreshing = true;
                            this.refreshVolume().finally(() => {
                                window.volumeRefreshing = false;
                            });
                        }
                    }, 300000);
                },
                
                async refreshVolume() {
                    if (this.loading) return;
                    
                    this.loading = true;
                    try {
                        const response = await fetch('/api/volume/daily?days=3');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result && result.status === 'success') {
                            this.volumeData = result.data || [];
                            this.calculateTotals();
                        } else {
                            console.error('Hacim bilgisi alma hatasÄ±:', result?.message || 'Bilinmeyen hata');
                        }
                    } catch (error) {
                        console.error('Hacim yenileme hatasÄ±:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                calculateTotals() {
                    this.totalLongVolume = 0;
                    this.totalShortVolume = 0;
                    this.totalTrades = 0;
                    
                    if (this.volumeData && Array.isArray(this.volumeData)) {
                        this.volumeData.forEach(day => {
                            if (day && typeof day === 'object') {
                                this.totalLongVolume += day.long_volume || 0;
                                this.totalShortVolume += day.short_volume || 0;
                                this.totalTrades += day.total_count || 0;
                            }
                        });
                    }
                    
                    this.totalNetVolume = this.totalLongVolume - this.totalShortVolume;
                }
            };
        }
        
        
        // Auto refresh kaldÄ±rÄ±ldÄ± - index.html'de tanÄ±mlÄ±
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
