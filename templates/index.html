{% extends "base.html" %}

{% block title %}Dashboard - Grid + OTT Trading Bot{% endblock %}

{% block content %}
<div x-data="{ refreshing: false }" 
     hx-get="/"
     hx-trigger="refresh"
     hx-target="body">

    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Trading Dashboard</h1>
            <p class="text-gray-600 mt-1">Grid + OTT stratejilerini y√∂netin ve takip edin</p>
            <p class="text-sm text-gray-500 mt-1">
                Son g√ºncelleme: <span id="last-update-time">{{ get_istanbul_now().strftime('%d.%m.%Y %H:%M:%S') }}</span>
            </p>
        </div>
        
        <div class="flex space-x-3">
            <!-- Trading Durumu D√ºƒümesi -->
            <div x-data="{ tradingPaused: false }" 
                 x-init="
                    fetch('/api/trading/status')
                        .then(response => response.json())
                        .then(data => tradingPaused = data.paused)
                 ">
                <button x-show="!tradingPaused"
                        hx-post="/api/trading/pause"
                        hx-target="body"
                        class="btn btn-warning"
                        @click="tradingPaused = true">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Trading Beklet
                </button>
                
                <button x-show="tradingPaused"
                        hx-post="/api/trading/resume"
                        hx-target="body"
                        class="btn btn-success"
                        @click="tradingPaused = false">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Trading Devam Et
                </button>
            </div>
            
            <button @click="refreshing = true; setTimeout(() => refreshing = false, 1000)"
                    hx-get="/"
                    hx-target="body"
                    class="btn btn-secondary"
                    :class="{ 'loading': refreshing }">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Yenile
            </button>
            
            <button hx-post="/api/terminal/clear"
                    hx-target="body"
                    class="btn btn-secondary"
                    title="Terminali temizle">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Terminal Temizle
            </button>
            
            <button hx-post="/api/logs/clear"
                    hx-target="body"
                    class="btn btn-secondary"
                    title="Log dosyalarƒ±nƒ± temizle"
                    onclick="return confirm('Log dosyalarƒ± temizlenecek. Devam etmek istiyor musunuz?')">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Log Temizle
            </button>
            
            <button @click="$dispatch('open-modal', {modal: 'create-strategy'})"
                    class="btn btn-primary">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Yeni Strateji
            </button>
        </div>
    </div>

    <!-- Pozisyon Takip Sistemi -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6" 
         x-data="positionTracker()" 
         x-init="init()">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">
                <span class="mr-2">üí∞</span>Net Pozisyon Takibi
            </h2>
            <button @click="refreshPositions()" 
                    class="btn btn-sm btn-secondary"
                    :class="{ 'loading': loading }">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Yenile
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <!-- Net Pozisyon -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-sm font-medium text-gray-600 mb-1">Net Pozisyon</div>
                <div class="text-2xl font-bold" 
                     :class="netPosition >= 0 ? 'text-green-600' : 'text-red-600'"
                     x-text="'$' + netPosition.toFixed(2)">
                    $0.00
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    Long: <span x-text="'$' + totalLong.toFixed(2)" class="text-green-600">$0.00</span> | 
                    Short: <span x-text="'$' + totalShort.toFixed(2)" class="text-red-600">$0.00</span>
                </div>
            </div>
            
            <!-- Risk Durumu -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-sm font-medium text-gray-600 mb-1">Risk Durumu</div>
                <div class="text-sm" x-show="riskStatus === 'safe'">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        ‚úÖ G√ºvenli
                    </span>
                </div>
                <div class="text-sm" x-show="riskStatus === 'warning'">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        ‚ö†Ô∏è Dikkat
                    </span>
                </div>
                <div class="text-sm" x-show="riskStatus === 'danger'">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        üö® Tehlikeli
                    </span>
                </div>
                <div class="text-xs text-gray-500 mt-1" x-text="riskMessage">-</div>
            </div>
            
            <!-- Pozisyon Limitleri -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-sm font-medium text-gray-600 mb-2">Pozisyon Limitleri</div>
                <div class="space-y-2">
                    <div class="flex items-center space-x-2">
                        <label class="text-xs text-gray-600 w-12">Max:</label>
                        <input type="number" 
                               x-model="maxLimit" 
                               @change="updateLimits()"
                               class="form-input text-xs py-1 px-2 w-20"
                               step="100">
                        <span class="text-xs text-gray-500">$</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-xs text-gray-600 w-12">Min:</label>
                        <input type="number" 
                               x-model="minLimit" 
                               @change="updateLimits()"
                               class="form-input text-xs py-1 px-2 w-20"
                               step="100">
                        <span class="text-xs text-gray-500">$</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pozisyon Detaylarƒ± -->
        <div class="overflow-x-auto" x-show="positions.length > 0">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Sembol</th>
                        <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Y√∂n</th>
                        <th class="text-right py-2 px-3 text-xs font-medium text-gray-600 uppercase">Boyut</th>
                        <th class="text-right py-2 px-3 text-xs font-medium text-gray-600 uppercase">Giri≈ü</th>
                        <th class="text-right py-2 px-3 text-xs font-medium text-gray-600 uppercase">G√ºncel</th>
                        <th class="text-right py-2 px-3 text-xs font-medium text-gray-600 uppercase">PNL</th>
                        <th class="text-right py-2 px-3 text-xs font-medium text-gray-600 uppercase">USD Deƒüeri</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="position in positions" :key="position.symbol">
                        <tr class="border-b border-gray-100">
                            <td class="py-2 px-3 text-sm font-medium" x-text="position.symbol"></td>
                            <td class="py-2 px-3">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                      :class="position.side === 'long' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                      x-text="position.side === 'long' ? 'üìà Long' : 'üìâ Short'">
                                </span>
                            </td>
                            <td class="py-2 px-3 text-right text-sm" x-text="position.size.toFixed(6)"></td>
                            <td class="py-2 px-3 text-right text-sm" x-text="'$' + position.entry_price.toFixed(4)"></td>
                            <td class="py-2 px-3 text-right text-sm" x-text="'$' + position.mark_price.toFixed(4)"></td>
                            <td class="py-2 px-3 text-right text-sm font-medium"
                                :class="position.unrealized_pnl >= 0 ? 'text-green-600' : 'text-red-600'"
                                x-text="'$' + position.unrealized_pnl.toFixed(2)"></td>
                            <td class="py-2 px-3 text-right text-sm font-medium" 
                                x-text="'$' + position.position_usd.toFixed(2)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        <div x-show="positions.length === 0" class="text-center py-4 text-gray-500">
            üì≠ Aktif pozisyon bulunamadƒ±
        </div>
    </div>

    <!-- G√ºnl√ºk Hacim ƒ∞statistikleri -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6" 
         x-data="volumeTracker()" 
         x-init="init()">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">
                <span class="mr-2">üìä</span>Son 3 G√ºn√ºn ƒ∞≈ülem Hacmi
            </h2>
            <button @click="refreshVolume()" 
                    class="btn btn-sm btn-secondary"
                    :class="{ 'loading': loading }">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Yenile
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 text-sm font-medium text-gray-600">Tarih</th>
                        <th class="text-right py-3 px-4 text-sm font-medium text-gray-600">Long Hacmi</th>
                        <th class="text-right py-3 px-4 text-sm font-medium text-gray-600">Short Hacmi</th>
                        <th class="text-right py-3 px-4 text-sm font-medium text-gray-600">Net Hacim</th>
                        <th class="text-right py-3 px-4 text-sm font-medium text-gray-600">Toplam Hacim</th>
                        <th class="text-center py-3 px-4 text-sm font-medium text-gray-600">ƒ∞≈ülem Sayƒ±sƒ±</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="day in volumeData" :key="day.date_iso">
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-sm font-medium text-gray-900" x-text="day.date"></td>
                            <td class="py-3 px-4 text-right text-sm">
                                <span class="text-green-600 font-medium" x-text="'$' + day.long_volume.toFixed(2)"></span>
                                <div class="text-xs text-gray-500" x-text="day.long_count + ' i≈ülem'"></div>
                            </td>
                            <td class="py-3 px-4 text-right text-sm">
                                <span class="text-red-600 font-medium" x-text="'$' + day.short_volume.toFixed(2)"></span>
                                <div class="text-xs text-gray-500" x-text="day.short_count + ' i≈ülem'"></div>
                            </td>
                            <td class="py-3 px-4 text-right text-sm font-medium"
                                :class="day.net_volume >= 0 ? 'text-green-600' : 'text-red-600'"
                                x-text="(day.net_volume >= 0 ? '+$' : '-$') + Math.abs(day.net_volume).toFixed(2)"></td>
                            <td class="py-3 px-4 text-right text-sm font-semibold text-gray-900" 
                                x-text="'$' + day.total_volume.toFixed(2)"></td>
                            <td class="py-3 px-4 text-center text-sm">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                                      x-text="day.total_count"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        <div x-show="volumeData.length === 0" class="text-center py-8 text-gray-500">
            üìà Hen√ºz i≈ülem verisi bulunamadƒ±
        </div>
        
        <!-- √ñzet ƒ∞statistikler -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6 pt-4 border-t border-gray-200">
            <div class="bg-green-50 rounded-lg p-3">
                <div class="text-xs font-medium text-green-600 mb-1">Toplam Long</div>
                <div class="text-lg font-bold text-green-700" x-text="'$' + totalLongVolume.toFixed(2)">$0.00</div>
            </div>
            <div class="bg-red-50 rounded-lg p-3">
                <div class="text-xs font-medium text-red-600 mb-1">Toplam Short</div>
                <div class="text-lg font-bold text-red-700" x-text="'$' + totalShortVolume.toFixed(2)">$0.00</div>
            </div>
            <div class="bg-blue-50 rounded-lg p-3">
                <div class="text-xs font-medium text-blue-600 mb-1">Net Hacim</div>
                <div class="text-lg font-bold" 
                     :class="totalNetVolume >= 0 ? 'text-green-700' : 'text-red-700'"
                     x-text="(totalNetVolume >= 0 ? '+$' : '-$') + Math.abs(totalNetVolume).toFixed(2)">$0.00</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
                <div class="text-xs font-medium text-gray-600 mb-1">Toplam ƒ∞≈ülem</div>
                <div class="text-lg font-bold text-gray-700" x-text="totalTrades">0</div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
        <div class="card">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Toplam Strateji</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.total_strategies }}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 rounded-lg">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Aktif Strateji</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.active_strategies }}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center">
                <div class="p-2 bg-yellow-100 rounded-lg">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">A√ßƒ±k Emir</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.total_open_orders }}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center">
                <div class="p-2 bg-purple-100 rounded-lg">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Bug√ºnk√º ƒ∞≈ülem</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.total_trades_today }}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center">
                <div class="p-2 {% if stats.total_profit_today >= 0 %}bg-green-100{% else %}bg-red-100{% endif %} rounded-lg">
                    <svg class="w-6 h-6 {% if stats.total_profit_today >= 0 %}text-green-600{% else %}text-red-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Toplam Kar/Zarar</p>
                    <p class="text-2xl font-semibold {% if stats.total_profit_today >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if stats.total_profit_today >= 0 %}+{% endif %}${{ stats.total_profit_today | format_number(2) }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Trading Durumu Kartƒ± -->
        <div class="card" x-data="{ tradingPaused: false }" 
             x-init="
                fetch('/api/trading/status')
                    .then(response => response.json())
                    .then(data => tradingPaused = data.paused)
             ">
            <div class="flex items-center">
                <div class="p-2 rounded-lg" :class="tradingPaused ? 'bg-red-100' : 'bg-green-100'">
                    <svg class="w-6 h-6" :class="tradingPaused ? 'text-red-600' : 'text-green-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path x-show="!tradingPaused" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        <path x-show="tradingPaused" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Trading Durumu</p>
                    <p class="text-lg font-semibold" :class="tradingPaused ? 'text-red-600' : 'text-green-600'">
                        <span x-show="!tradingPaused">üü¢ Aktif</span>
                        <span x-show="tradingPaused">üî¥ Bekletildi</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategies List -->
    <div class="card">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-900">Stratejiler</h2>
            
            {% if strategies|length == 0 %}
            <span class="text-sm text-gray-500">Hen√ºz strateji yok</span>
            {% endif %}
        </div>

        {% if strategies|length > 0 %}
        
        <!-- Grid + OTT Stratejileri -->
        {% set grid_strategies = strategies | selectattr("strategy.strategy_type.value", "equalto", "grid_ott") | list %}
        {% if grid_strategies|length > 0 %}
        <div class="mb-8">
            <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                Grid + OTT Stratejileri ({{ grid_strategies|length }})
            </h3>
            
            <div class="overflow-x-auto table-responsive">
                <table class="min-w-full divide-y divide-gray-200" style="min-width: 1200px;">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Strateji
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Durum
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Sembol
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                OTT Modu
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fiyat / GF
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fark
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider table-hide-mobile">
                                Fiyat Limitleri
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                A√ßƒ±k Emir
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ƒ∞≈ülemler
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Kar/Zarar
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Aksiyonlar
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for item in grid_strategies %}
                        <tr class="hover:bg-gray-50 {% if not item.strategy.active %}bg-orange-50 border-l-4 border-orange-400{% endif %}" data-strategy-id="{{ item.strategy.id }}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">
                                            <a href="/strategies/{{ item.strategy.id }}" 
                                               class="text-blue-600 hover:text-blue-800">
                                                {{ item.strategy.name }}
                                            </a>
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {{ item.strategy.timeframe.value }} | 
                                            Grid: {{ item.strategy.y | format_number(6) }} | 
                                            USDT: {{ item.strategy.usdt_grid | format_number(2) }}
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            üéØ Grid+OTT | ID: {{ item.strategy.id }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex flex-col space-y-1">
                                    {% if item.strategy.active %}
                                        <span class="status-badge status-active">Aktif</span>
                                    {% else %}
                                        <span class="status-badge status-inactive">Pasif</span>
                                    {% endif %}
                                    
                                    {% if item.is_running %}
                                        <span class="status-badge status-running">√áalƒ±≈üƒ±yor</span>
                                    {% endif %}
                                    
                                    {% if item.error_count and item.error_count > 0 %}
                                        <span class="status-badge bg-red-100 text-red-800 text-xs">
                                            ‚ö†Ô∏è {{ item.error_count }}/3 Hata
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ item.strategy.symbol.value }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    OTT: {{ item.strategy.ott.period }}/{{ item.strategy.ott.opt }}%
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if item.ott_mode %}
                                    {% if item.ott_mode == 'AL' %}
                                        <span class="status-badge status-active">üü¢ AL</span>
                                    {% else %}
                                        <span class="status-badge bg-red-100 text-red-800">üî¥ SAT</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400 text-sm">-</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900 strategy-price">
                                    {% if item.current_price %}
                                        ${{ item.current_price | format_number(6) }}
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </div>
                                <div class="text-sm text-gray-500 strategy-gf">
                                    {% if item.state and item.state.gf is not none and item.state.gf > 0 %}
                                        GF: ${{ item.state.gf | format_number(6) }}
                                    {% else %}
                                        <span class="text-gray-400">GF: Ayarlanmadƒ±</span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap strategy-diff">
                                {% if item.price_gf_diff is not none %}
                                    <div class="text-sm font-medium {% if item.price_gf_diff > 0 %}text-green-600{% elif item.price_gf_diff < 0 %}text-red-600{% else %}text-gray-900{% endif %}">
                                        {% if item.price_gf_diff > 0 %}+{% endif %}{{ item.price_gf_diff | format_number(4) }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {% if item.price_gf_diff_pct > 0 %}+{% endif %}{{ item.price_gf_diff_pct | format_number(2) }}%
                                    </div>
                                {% else %}
                                    <span class="text-gray-400 text-sm">-</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap table-hide-mobile">
                                {% if item.strategy.price_min or item.strategy.price_max %}
                                    <div class="text-xs space-y-1">
                                        {% if item.strategy.price_min %}
                                            <div class="text-green-600">
                                                Min: ${{ item.strategy.price_min | format_number(6) }}
                                            </div>
                                        {% endif %}
                                        {% if item.strategy.price_max %}
                                            <div class="text-red-600">
                                                Max: ${{ item.strategy.price_max | format_number(6) }}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-gray-400 text-xs">Limit yok</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 strategy-orders">
                                {% if item.state %}
                                    {{ item.state.open_orders | length }}
                                {% else %}
                                    0
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    Bug√ºn: {{ item.trades_today }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    Toplam: {{ item.strategy.total_trades }}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if item.pnl_stats %}
                                    <div class="text-sm font-medium {% if item.pnl_stats.realized_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                        {% if item.pnl_stats.realized_pnl >= 0 %}+{% endif %}${{ item.pnl_stats.realized_pnl | format_number(2) }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {% if item.pnl_stats.profit_trades > 0 or item.pnl_stats.loss_trades > 0 %}
                                            {{ item.pnl_stats.win_rate | format_number(1) }}% win ‚Ä¢ ${{ item.pnl_stats.open_buy_value | format_number(2) }} a√ßƒ±k
                                        {% elif item.pnl_stats.open_buy_value > 0 %}
                                            ${{ item.pnl_stats.open_buy_value | format_number(2) }} a√ßƒ±k pozisyon
                                        {% else %}
                                            Hen√ºz i≈ülem yok
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-gray-400 text-sm">-</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex justify-end space-x-2">
                                    {% if item.strategy.active %}
                                        <button hx-post="/api/strategies/{{ item.strategy.id }}/stop"
                                                hx-target="body"
                                                hx-confirm="Bu stratejiyi durdurmak istediƒüinize emin misiniz?"
                                                class="text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50">
                                            Durdur
                                        </button>
                                    {% else %}
                                        <button hx-post="/api/strategies/{{ item.strategy.id }}/start"
                                                hx-target="body"
                                                class="text-green-600 hover:text-green-900 text-xs px-2 py-1 rounded border border-green-300 hover:bg-green-50">
                                            Ba≈ülat
                                        </button>
                                    {% endif %}
                                    
                                    <button @click="$dispatch('open-edit-modal', {
                                                strategyId: '{{ item.strategy.id }}',
                                                name: '{{ item.strategy.name }}',
                                                y: {{ item.strategy.y }},
                                                usdt_grid: {{ item.strategy.usdt_grid }},
                                                gf: {{ item.strategy.gf }},
                                                price_min: {{ item.strategy.price_min or 'null' }},
                                                price_max: {{ item.strategy.price_max or 'null' }},
                                                ott_period: {{ item.strategy.ott.period }},
                                                ott_opt: {{ item.strategy.ott.opt }}
                                            })"
                                            class="text-purple-600 hover:text-purple-900 text-xs px-2 py-1 rounded border border-purple-300 hover:bg-purple-50">
                                        D√ºzenle
                                    </button>
                                    
                                    <a href="/strategies/{{ item.strategy.id }}"
                                       class="text-blue-600 hover:text-blue-900 text-xs px-2 py-1 rounded border border-blue-300 hover:bg-blue-50">
                                        Detay
                                    </a>
                                    
                                    <button hx-delete="/api/strategies/{{ item.strategy.id }}"
                                            hx-target="body"
                                            hx-confirm="Bu stratejiyi silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz."
                                            class="text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50">
                                        Sil
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- DCA + OTT Stratejileri -->
        {% set dca_strategies = strategies | selectattr("strategy.strategy_type.value", "equalto", "dca_ott") | list %}
        {% if dca_strategies|length > 0 %}
        <div class="mb-8">
            <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                <span class="w-3 h-3 bg-orange-500 rounded-full mr-2"></span>
                DCA + OTT Stratejileri ({{ dca_strategies|length }})
            </h3>
            
            <div class="overflow-x-auto table-responsive">
                <table class="min-w-full divide-y divide-gray-200" style="min-width: 1200px;">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Strateji
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Durum
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Sembol
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                OTT Modu
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fiyat / Ort. Maliyet
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Son Alƒ±m / Fark
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Pozisyon
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ƒ∞≈ülemler
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Kar/Zarar
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Aksiyonlar
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for item in dca_strategies %}
                        <tr class="hover:bg-gray-50 {% if not item.strategy.active %}bg-orange-50 border-l-4 border-orange-400{% endif %}" data-strategy-id="{{ item.strategy.id }}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">
                                            <a href="/strategies/{{ item.strategy.id }}" 
                                               class="text-blue-600 hover:text-blue-800">
                                                {{ item.strategy.name }}
                                            </a>
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {{ item.strategy.timeframe.value }} | 
                                            DCA: ${{ item.strategy.parameters.get('base_usdt', 'N/A') }} | 
                                            √áarpan: {{ item.strategy.parameters.get('dca_multiplier', 'N/A') }}x
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            üî• DCA+OTT | ID: {{ item.strategy.id }}
                                            {% if item.dca_info and item.dca_info.cycle_number is not none %}
                                                | D√∂ng√º: D{{ item.dca_info.cycle_number }}
                                                {% if item.dca_info.cycle_trade_count > 0 %}
                                                    -{{ item.dca_info.cycle_trade_count }}
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex flex-col space-y-1">
                                    {% if item.strategy.active %}
                                        <span class="status-badge status-active">Aktif</span>
                                    {% else %}
                                        <span class="status-badge status-inactive">Pasif</span>
                                    {% endif %}
                                    
                                    {% if item.is_running %}
                                        <span class="status-badge status-running">√áalƒ±≈üƒ±yor</span>
                                    {% endif %}
                                    
                                    {% if item.error_count and item.error_count > 0 %}
                                        <span class="status-badge bg-red-100 text-red-800 text-xs">
                                            ‚ö†Ô∏è {{ item.error_count }}/3 Hata
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ item.strategy.symbol.value }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    OTT: {{ item.strategy.ott.period }}/{{ item.strategy.ott.opt }}%
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if item.ott_mode %}
                                    {% if item.ott_mode == 'AL' %}
                                        <span class="status-badge status-active">üü¢ AL</span>
                                    {% else %}
                                        <span class="status-badge bg-red-100 text-red-800">üî¥ SAT</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400 text-sm">-</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900 strategy-price">
                                    {% if item.current_price %}
                                        ${{ item.current_price | format_number(6) }}
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </div>
                                <div class="text-sm text-gray-500 strategy-gf">
                                    {% if item.state and item.state.avg_cost and item.state.avg_cost > 0 %}
                                        Ort: ${{ item.state.avg_cost | format_number(6) }}
                                    {% else %}
                                        <span class="text-gray-400">Pozisyon yok</span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap strategy-diff">
                                {% if item.dca_info and item.dca_info.last_buy_price %}
                                    <div class="text-sm text-gray-900">
                                        Son: ${{ item.dca_info.last_buy_price | format_number(6) }}
                                    </div>
                                    {% if item.current_price and item.dca_info.last_buy_price %}
                                        {% set price_diff = item.current_price - item.dca_info.last_buy_price %}
                                        {% set price_diff_pct = (price_diff / item.dca_info.last_buy_price) * 100 %}
                                        <div class="text-xs {% if price_diff > 0 %}text-green-600{% elif price_diff < 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                                            {% if price_diff > 0 %}+{% endif %}{{ price_diff_pct | format_number(2) }}%
                                        </div>
                                    {% endif %}
                                    {% if item.dca_info.first_buy_price %}
                                        <div class="text-xs text-gray-400">
                                            ƒ∞lk: ${{ item.dca_info.first_buy_price | format_number(6) }}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400 text-sm">-</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if item.state and item.state.total_quantity and item.state.total_quantity > 0 %}
                                    <div class="text-sm text-gray-900">
                                        {{ item.state.total_quantity | format_number(6) }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        ${{ (item.state.total_quantity * item.state.avg_cost) | format_number(2) }}
                                    </div>
                                    {% if item.dca_info and item.dca_info.position_count %}
                                        <div class="text-xs text-blue-600">
                                            {{ item.dca_info.position_count }} pozisyon
                                        </div>
                                    {% endif %}
                                    {% if item.dca_info and item.dca_info.cycle_number is not none %}
                                        <div class="text-xs text-purple-600">
                                            D√∂ng√º: D{{ item.dca_info.cycle_number }}
                                            {% if item.dca_info.cycle_trade_count > 0 %}
                                                -{{ item.dca_info.cycle_trade_count }}
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400 text-sm">Pozisyon yok</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    Bug√ºn: {{ item.trades_today }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    Toplam: {{ item.strategy.total_trades }}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if item.pnl_stats %}
                                    <div class="text-sm font-medium {% if item.pnl_stats.realized_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                        {% if item.pnl_stats.realized_pnl >= 0 %}+{% endif %}${{ item.pnl_stats.realized_pnl | format_number(2) }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {% if item.pnl_stats.profit_trades > 0 or item.pnl_stats.loss_trades > 0 %}
                                            {{ item.pnl_stats.win_rate | format_number(1) }}% win ‚Ä¢ ${{ item.pnl_stats.open_buy_value | format_number(2) }} a√ßƒ±k
                                        {% elif item.pnl_stats.open_buy_value > 0 %}
                                            ${{ item.pnl_stats.open_buy_value | format_number(2) }} a√ßƒ±k pozisyon
                                        {% else %}
                                            Hen√ºz i≈ülem yok
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-gray-400 text-sm">-</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex justify-end space-x-2">
                                    {% if item.strategy.active %}
                                        <button hx-post="/api/strategies/{{ item.strategy.id }}/stop"
                                                hx-target="body"
                                                hx-confirm="Bu stratejiyi durdurmak istediƒüinize emin misiniz?"
                                                class="text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50">
                                            Durdur
                                        </button>
                                    {% else %}
                                        <button hx-post="/api/strategies/{{ item.strategy.id }}/start"
                                                hx-target="body"
                                                class="text-green-600 hover:text-green-900 text-xs px-2 py-1 rounded border border-green-300 hover:bg-green-50">
                                            Ba≈ülat
                                        </button>
                                    {% endif %}
                                    
                                    <button @click="$dispatch('open-edit-modal', {
                                                strategyId: '{{ item.strategy.id }}',
                                                name: '{{ item.strategy.name }}',
                                                y: {{ item.strategy.y }},
                                                usdt_grid: {{ item.strategy.usdt_grid }},
                                                gf: {{ item.strategy.gf }},
                                                price_min: {{ item.strategy.price_min or 'null' }},
                                                price_max: {{ item.strategy.price_max or 'null' }},
                                                ott_period: {{ item.strategy.ott.period }},
                                                ott_opt: {{ item.strategy.ott.opt }}
                                            })"
                                            class="text-purple-600 hover:text-purple-900 text-xs px-2 py-1 rounded border border-purple-300 hover:bg-purple-50">
                                        D√ºzenle
                                    </button>
                                    
                                    <a href="/strategies/{{ item.strategy.id }}"
                                       class="text-blue-600 hover:text-blue-900 text-xs px-2 py-1 rounded border border-blue-300 hover:bg-blue-50">
                                        Detay
                                    </a>
                                    
                                    <button hx-delete="/api/strategies/{{ item.strategy.id }}"
                                            hx-target="body"
                                            hx-confirm="Bu stratejiyi silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz."
                                            class="text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50">
                                        Sil
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- BOL-Grid Stratejileri -->
        {% set bol_grid_strategies = strategies | selectattr("strategy.strategy_type.value", "equalto", "bol_grid") | list %}
        {% if bol_grid_strategies|length > 0 %}
        <div class="mb-8">
            <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                BOL-Grid Stratejileri ({{ bol_grid_strategies|length }})
            </h3>
            
            <div class="overflow-x-auto table-responsive">
                <table class="min-w-full divide-y divide-gray-200" style="min-width: 1200px;">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Strateji
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Durum
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Sembol
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fiyat / Ort. Maliyet
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                D√∂ng√º / Pozisyon
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider table-hide-mobile">
                                Bollinger Bands
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                A√ßƒ±k Emirler
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ƒ∞≈ülemler
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Kar/Zarar
                            </th>
                            <th class="px-6 py-3 relative">
                                <span class="sr-only">ƒ∞≈ülemler</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for item in bol_grid_strategies %}
                        <tr class="hover:bg-gray-50 {% if not item.strategy.active %}bg-orange-50 border-l-4 border-orange-400{% endif %}" data-strategy-id="{{ item.strategy.id }}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">
                                            <a href="/strategies/{{ item.strategy.id }}" 
                                               class="text-blue-600 hover:text-blue-900 hover:underline">
                                                {{ item.strategy.name }}
                                            </a>
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {{ item.strategy.timeframe.value }} ‚Ä¢ 
                                            BOL({{ item.strategy.parameters.bollinger_period }}, {{ item.strategy.parameters.bollinger_std }})
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex flex-col space-y-1">
                                    {% if item.strategy.active %}
                                        <span class="status-badge status-active">Aktif</span>
                                    {% else %}
                                        <span class="status-badge status-inactive">Pasif</span>
                                    {% endif %}
                                    
                                    {% if item.is_running %}
                                        <span class="status-badge status-running">√áalƒ±≈üƒ±yor</span>
                                    {% endif %}
                                    
                                    {% if item.error_count and item.error_count > 0 %}
                                        <span class="status-badge bg-red-100 text-red-800 text-xs">
                                            ‚ö†Ô∏è {{ item.error_count }}/3 Hata
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ item.strategy.symbol.value }}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900 strategy-price">
                                    {% if item.current_price %}
                                        ${{ item.current_price | format_number(6) }}
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {% if item.state and item.state.custom_data and item.state.custom_data.average_cost and item.state.custom_data.average_cost > 0 %}
                                        Ort: ${{ item.state.custom_data.average_cost | format_number(6) }}
                                    {% else %}
                                        <span class="text-gray-400">Pozisyon yok</span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if item.state and item.state.custom_data %}
                                    <div class="text-sm font-medium text-purple-600">
                                        {{ item.state.custom_data.cycle_step or 'D0' }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {% if item.state.custom_data.total_quantity and item.state.custom_data.total_quantity > 0 %}
                                            {{ item.state.custom_data.total_quantity | format_number(6) }} adet
                                        {% else %}
                                            Pozisyon yok
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-gray-400 text-sm">-</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap table-hide-mobile">
                                {% if item.state and item.state.custom_data and item.state.custom_data.last_bollinger %}
                                    <div class="text-xs space-y-1">
                                        <div class="text-blue-600">
                                            U: ${{ item.state.custom_data.last_bollinger.upper | format_number(4) }}
                                        </div>
                                        <div class="text-gray-600">
                                            M: ${{ item.state.custom_data.last_bollinger.middle | format_number(4) }}
                                        </div>
                                        <div class="text-red-600">
                                            L: ${{ item.state.custom_data.last_bollinger.lower | format_number(4) }}
                                        </div>
                                    </div>
                                {% else %}
                                    <span class="text-gray-400 text-xs">Hesaplanmadƒ±</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 strategy-orders">
                                {% if item.state %}
                                    {{ item.state.open_orders | length }}
                                {% else %}
                                    0
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    Bug√ºn: {{ item.trades_today }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Toplam: {{ item.strategy.total_trades }}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if item.pnl_stats %}
                                    <div class="text-sm font-medium {% if item.pnl_stats.realized_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                        {% if item.pnl_stats.realized_pnl >= 0 %}+{% endif %}${{ item.pnl_stats.realized_pnl | format_number(2) }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {% if item.pnl_stats.profit_trades > 0 or item.pnl_stats.loss_trades > 0 %}
                                            {{ item.pnl_stats.win_rate | format_number(1) }}% win ‚Ä¢ ${{ item.pnl_stats.open_buy_value | format_number(2) }} a√ßƒ±k
                                        {% elif item.pnl_stats.open_buy_value > 0 %}
                                            ${{ item.pnl_stats.open_buy_value | format_number(2) }} a√ßƒ±k
                                        {% else %}
                                            Hen√ºz i≈ülem yok
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-gray-400 text-sm">-</span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex justify-end space-x-2">
                                    {% if item.strategy.active %}
                                        <button hx-post="/api/strategies/{{ item.strategy.id }}/stop"
                                                hx-target="body"
                                                class="text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50">
                                            Durdur
                                        </button>
                                    {% else %}
                                        <button hx-post="/api/strategies/{{ item.strategy.id }}/start"
                                                hx-target="body"
                                                class="text-green-600 hover:text-green-900 text-xs px-2 py-1 rounded border border-green-300 hover:bg-green-50">
                                            Ba≈ülat
                                        </button>
                                    {% endif %}
                                    
                                    <a href="/strategies/{{ item.strategy.id }}" 
                                       class="text-blue-600 hover:text-blue-900 text-xs px-2 py-1 rounded border border-blue-300 hover:bg-blue-50">
                                        Detay
                                    </a>
                                    
                                    <button hx-delete="/api/strategies/{{ item.strategy.id }}"
                                            hx-target="body"
                                            hx-confirm="Bu stratejiyi silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz."
                                            class="text-red-600 hover:text-red-900 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50">
                                        Sil
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">Hen√ºz strateji yok</h3>
            <p class="mt-1 text-sm text-gray-500">
                ƒ∞lk Grid + OTT stratejinizi olu≈üturarak ba≈ülayƒ±n.
            </p>
            <div class="mt-6">
                <button @click="$dispatch('open-modal', {modal: 'create-strategy'})"
                        class="btn btn-primary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Yeni Strateji Olu≈ütur
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Open Orders Summary -->
    {% if open_orders|length > 0 %}
    <div class="card mt-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-900">üîÑ A√ßƒ±k Emirler</h2>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500">{{ open_orders|length }} a√ßƒ±k emir</span>
            </div>
        </div>

        <div class="overflow-x-auto table-responsive">
            <table class="min-w-full divide-y divide-gray-200 open-orders-table" style="min-width: 1200px;">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Strateji
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Sembol
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ƒ∞≈ülem
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Miktar
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Fiyat
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Emir Tipi
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Emir Durumu
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Grid Z
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Zaman
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for order in open_orders %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                <a href="/strategies/{{ order.strategy_id }}" 
                                   class="text-blue-600 hover:text-blue-800">
                                    {{ order.strategy_name }}
                                </a>
                            </div>
                            <div class="text-xs text-gray-500">
                                {{ order.strategy_id[:8] }}...
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                {{ order.symbol }}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if order.side == 'buy' %}
                                <span class="status-badge status-active">üü¢ AL</span>
                            {% else %}
                                <span class="status-badge bg-red-100 text-red-800">üî¥ SAT</span>
                            {% endif %}
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {{ order.quantity | format_number(6) }}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if order.price %}
                                <div class="text-sm text-gray-900">
                                    ${{ order.price | format_number(6) }}
                                </div>
                            {% else %}
                                <span class="text-sm text-gray-400">Market</span>
                            {% endif %}
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if order.order_type == 'LIMIT' %}
                                <span class="status-badge bg-blue-100 text-blue-800">üìã Limit</span>
                            {% else %}
                                <span class="status-badge bg-green-100 text-green-800">‚ö° Market</span>
                            {% endif %}
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {{ order.status }}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {% if order.z != 0 %}
                                    {{ order.z }}
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {{ order.timestamp | format_date_only }}
                            </div>
                            <div class="text-sm text-gray-500">
                                {{ order.timestamp | format_time_only }}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Recent Trades History -->
    {% if recent_trades|length > 0 %}
    <div class="card mt-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-900">Son ƒ∞≈ülemler</h2>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label for="strategy-filter" class="text-sm font-medium text-gray-700">Strateji:</label>
                    <select id="strategy-filter" 
                            name="strategy_filter"
                            class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            hx-get="/"
                            hx-target="body"
                            hx-trigger="change"
                            hx-vals="js:{strategy_filter: event.target.value}">
                        <option value="all" {% if selected_strategy_filter == "all" %}selected{% endif %}>T√ºm√º</option>
                        {% for strategy_data in strategies %}
                        <option value="{{ strategy_data.strategy.id }}" 
                                {% if selected_strategy_filter == strategy_data.strategy.id %}selected{% endif %}>
                            {{ strategy_data.strategy.name }} ({{ strategy_data.strategy.symbol.value }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <span class="text-sm text-gray-500">{{ recent_trades|length }} i≈ülem</span>
            </div>
        </div>

        <div class="overflow-x-auto table-responsive">
            <table class="min-w-full divide-y divide-gray-200" id="recent-trades-table" style="min-width: 1100px;">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Tarih/Saat
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Strateji
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ƒ∞≈ülem
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Miktar
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Fiyat (Ort.)
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider table-hide-mobile">
                            Limit Fiyat
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Toplam
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Grid Z
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Grid Ref.
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Kar/Zarar
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider table-hide-mobile">
                            Emir ID
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for enriched_trade in recent_trades %}
                    {% set trade = enriched_trade.trade %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {{ trade.timestamp | format_date_only }}
                            </div>
                            <div class="text-sm text-gray-500">
                                {{ trade.timestamp | format_time_only }}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                {{ enriched_trade.strategy_name }}
                            </div>
                            <div class="text-xs text-gray-500">
                                {{ trade.strategy_id[:8] }}...
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if trade.side.value == 'buy' %}
                                <span class="status-badge status-active">üü¢ ALIM</span>
                            {% else %}
                                <span class="status-badge bg-red-100 text-red-800">üî¥ SATIM</span>
                            {% endif %}
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {{ trade.quantity | format_number(6) }}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${{ trade.price | format_number(6) }}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap table-hide-mobile">
                            <div class="text-sm text-gray-500">
                                {% if trade.limit_price %}
                                    ${{ trade.limit_price | format_number(6) }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                ${{ trade.notional | format_number(2) }}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {% if trade.cycle_info %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        üîÑ {{ trade.cycle_info }}
                                    </span>
                                {% elif enriched_trade.strategy_type == 'dca_ott' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                        üìä DCA
                                    </span>
                                {% else %}
                                    Z{{ trade.z }}
                                {% endif %}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm grid-reference">
                                ${{ enriched_trade.grid_reference | format_number(6) }}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium {% if enriched_trade.trade_pnl > 0 %}pnl-positive{% elif enriched_trade.trade_pnl < 0 %}pnl-negative{% else %}pnl-neutral{% endif %}">
                                {% if enriched_trade.trade_pnl > 0 %}+{% endif %}${{ enriched_trade.trade_pnl | format_number(3) }}
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap table-hide-mobile">
                            {% if trade.order_id %}
                                <div class="text-xs text-gray-500 font-mono">
                                    {{ trade.order_id[:12] }}...
                                </div>
                            {% else %}
                                <span class="text-gray-400 text-xs">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Quick Tips -->
    {% if strategies|length == 0 %}
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-medium text-blue-900 mb-3">Hƒ±zlƒ± Ba≈ülangƒ±√ß ƒ∞pu√ßlarƒ±</h3>
        <div class="space-y-3 text-sm text-blue-800">
            <div class="flex items-start">
                <span class="flex-shrink-0 w-6 h-6 bg-blue-200 text-blue-800 rounded-full flex items-center justify-center text-xs font-bold mr-3 mt-0.5">1</span>
                <p><strong>Test ortamƒ±nda ba≈ülayƒ±n:</strong> env.example dosyasƒ±nƒ± .env olarak kopyalayƒ±n ve USE_TESTNET=true ayarlayƒ±n.</p>
            </div>
            <div class="flex items-start">
                <span class="flex-shrink-0 w-6 h-6 bg-blue-200 text-blue-800 rounded-full flex items-center justify-center text-xs font-bold mr-3 mt-0.5">2</span>
                <p><strong>K√º√ß√ºk tutarlarla test edin:</strong> ƒ∞lk stratejilerinizde d√º≈ü√ºk Grid Aralƒ±ƒüƒ± ve USDT/Grid deƒüerleri kullanƒ±n.</p>
            </div>
            <div class="flex items-start">
                <span class="flex-shrink-0 w-6 h-6 bg-blue-200 text-blue-800 rounded-full flex items-center justify-center text-xs font-bold mr-3 mt-0.5">3</span>
                <p><strong>OTT parametrelerini anlayƒ±n:</strong> Period=14, Opt=2.0 ba≈ülangƒ±√ß i√ßin iyi deƒüerlerdir.</p>
            </div>
            <div class="flex items-start">
                <span class="flex-shrink-0 w-6 h-6 bg-blue-200 text-blue-800 rounded-full flex items-center justify-center text-xs font-bold mr-3 mt-0.5">4</span>
                <p><strong>Risk y√∂netimi:</strong> Futures trading y√ºksek risklidir. Kaybetmeyi g√∂ze alamayacaƒüƒ±nƒ±z parayƒ± kullanmayƒ±n.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global deƒüi≈üken ile duplicate interval'larƒ± √∂nle
    if (window.dashboardInterval) {
        clearInterval(window.dashboardInterval);
    }
    
    // Auto-refresh strategies every 60 seconds (1 dakika)
    window.dashboardInterval = setInterval(function() {
        console.log('Dashboard otomatik yenileniyor...', new Date().toLocaleTimeString());
        // HTMX'e doƒürudan GET request g√∂nder
        htmx.ajax('GET', '/', {target: 'body'});
    }, 60000);
    
    // Real-time updates via Server-Sent Events
    function initRealTimeUpdates() {
        if (typeof(EventSource) !== "undefined") {
            const eventSource = new EventSource('/api/stream');
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateStrategyPrices(data.strategies);
                    
                    // ƒ∞≈ülem ge√ßmi≈üini g√ºncelle
                    if (data.recent_trades) {
                        updateRecentTrades(data.recent_trades);
                    }
                    
                    // Son g√ºncelleme zamanƒ±nƒ± g√ºncelle
                    const timeElement = document.getElementById('last-update-time');
                    if (timeElement && data.timestamp) {
                        const now = new Date(data.timestamp);
                        timeElement.textContent = `${now.toLocaleDateString('tr-TR')} ${now.toLocaleTimeString('tr-TR')}`;
                    }
                    
                    // Trading durumunu g√ºncelle
                    if (data.trading_status) {
                        updateTradingStatus(data.trading_status);
                    }
                } catch (e) {
                    console.error('SSE parsing error:', e);
                }
            };
            
            eventSource.onerror = function(event) {
                console.log('SSE connection error, will retry...');
                // EventSource otomatik reconnect yapar
            };
            
            eventSource.onopen = function(event) {
                console.log('SSE connection opened');
            };
        } else {
            console.log('SSE not supported, using fallback');
        }
    }
    
    function updateStrategyPrices(strategies) {
        strategies.forEach(strategy => {
            // Fiyat g√ºncelle
            const priceCell = document.querySelector(`[data-strategy-id="${strategy.id}"] .strategy-price`);
            if (priceCell) {
                priceCell.textContent = `$${strategy.price.toFixed(6)}`;
            }
            
            // GF g√ºncelle
            const gfCell = document.querySelector(`[data-strategy-id="${strategy.id}"] .strategy-gf`);
            if (gfCell && strategy.gf > 0) {
                gfCell.textContent = `GF: $${strategy.gf.toFixed(6)}`;
            }
            
            // Fark g√ºncelle
            const diffCell = document.querySelector(`[data-strategy-id="${strategy.id}"] .strategy-diff`);
            if (diffCell && strategy.gf > 0) {
                const diffPct = ((strategy.diff / strategy.gf) * 100).toFixed(2);
                const diffClass = strategy.diff > 0 ? 'text-green-600' : strategy.diff < 0 ? 'text-red-600' : 'text-gray-900';
                const diffSign = strategy.diff > 0 ? '+' : '';
                
                diffCell.innerHTML = `
                    <div class="text-sm font-medium ${diffClass}">
                        ${diffSign}${strategy.diff.toFixed(4)}
                    </div>
                    <div class="text-xs text-gray-500">
                        ${diffSign}${diffPct}%
                    </div>
                `;
            }
            
            // A√ßƒ±k emir sayƒ±sƒ± g√ºncelle
            const ordersCell = document.querySelector(`[data-strategy-id="${strategy.id}"] .strategy-orders`);
            if (ordersCell) {
                ordersCell.textContent = strategy.open_orders;
            }
        });
    }
    
    function updateTradingStatus(tradingStatus) {
        // Alpine.js component'lerini g√ºncelle
        const tradingStatusComponents = document.querySelectorAll('[x-data*="tradingPaused"]');
        tradingStatusComponents.forEach(component => {
            if (component._x_dataStack && component._x_dataStack[0]) {
                component._x_dataStack[0].tradingPaused = tradingStatus.paused;
            }
        });
    }
    
    function updateRecentTrades(trades) {
        const tradesTableBody = document.querySelector('#recent-trades-table tbody');
        if (!tradesTableBody || !trades || trades.length === 0) return;
        
        // Mevcut trade ID'lerini topla (duplicate kontrol√º i√ßin)
        const existingTradeIds = new Set();
        tradesTableBody.querySelectorAll('tr[data-trade-id]').forEach(row => {
            existingTradeIds.add(row.getAttribute('data-trade-id'));
        });
        
        // Sadece yeni trade'ler varsa tabloyu g√ºncelle
        let hasNewTrades = false;
        let newTradesCount = 0;
        
        // Yeni trade'leri kontrol et
        trades.forEach(trade => {
            const tradeId = `${trade.strategy_id}_${trade.timestamp}_${trade.order_id || 'no_id'}`;
            if (!existingTradeIds.has(tradeId)) {
                hasNewTrades = true;
                newTradesCount++;
            }
        });
        
        if (hasNewTrades) {
            console.log(`Yeni ${newTradesCount} trade bulundu, tablo g√ºncelleniyor...`);
            
            // Tablo i√ßeriƒüini g√ºncelle
            tradesTableBody.innerHTML = '';
            
            trades.forEach(trade => {
                const date = new Date(trade.timestamp);
                const tradeId = `${trade.strategy_id}_${trade.timestamp}_${trade.order_id || 'no_id'}`;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 new-trade-highlight';
                row.setAttribute('data-trade-id', tradeId);
                
                const sideClass = trade.side === 'buy' ? 'status-active' : 'bg-red-100 text-red-800';
                const sideIcon = trade.side === 'buy' ? 'üü¢' : 'üî¥';
                const sideText = trade.side === 'buy' ? 'ALIM' : 'SATIM';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            ${date.toLocaleDateString('tr-TR')}
                        </div>
                        <div class="text-sm text-gray-500">
                            ${date.toLocaleTimeString('tr-TR')}
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">
                            ${trade.strategy_id}
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${sideClass}">${sideIcon} ${sideText}</span>
                    </td>
                    
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            ${trade.quantity.toFixed(6)}
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            $${trade.price.toFixed(6)}
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">
                            $${trade.notional.toFixed(2)}
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            ${trade.cycle_info ? 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">üîÑ ${trade.cycle_info}</span>` : 
                                (trade.strategy_type === 'dca_ott' ? 
                                    `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">üìä DCA</span>` : 
                                    `Z${trade.z}`)
                            }
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${trade.order_id ? 
                            `<div class="text-xs text-gray-500 font-mono">${trade.order_id}</div>` : 
                            '<span class="text-gray-400 text-xs">-</span>'
                        }
                    </td>
                `;
                
                tradesTableBody.appendChild(row);
            });
            
            // Yeni trade animasyonu
            setTimeout(() => {
                document.querySelectorAll('.new-trade-highlight').forEach(row => {
                    row.classList.remove('new-trade-highlight');
                });
            }, 2000);
        }
    }
    
    // Sayfa y√ºklendiƒüinde SSE'yi ba≈ülat
    document.addEventListener('DOMContentLoaded', initRealTimeUpdates);
    
    // Show loading state for buttons
    document.addEventListener('htmx:beforeRequest', function(event) {
        if (event.target.tagName === 'BUTTON') {
            event.target.classList.add('loading');
            event.target.disabled = true;
        }
    });
    
    document.addEventListener('htmx:afterRequest', function(event) {
        if (event.target.tagName === 'BUTTON') {
            event.target.classList.remove('loading');
            event.target.disabled = false;
        }
    });
</script>
{% endblock %}
